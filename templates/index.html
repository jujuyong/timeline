<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì•„í‹°ìŠ¤íŠ¸ íƒ€ì„ë¼ì¸ ìš”ì•½</title>
  <style>
    #loading {
      font-weight: bold;
      color: #555;
      margin-top: 10px;
    }
    #summaryResult {
      margin-top: 15px;
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .profile-preview {
  display: flex; align-items: center; margin-bottom: 18px;
}
.profile-avatar {
  width: 54px; height: 54px; border-radius: 50%; margin-right: 14px;
}
.profile-name {
  font-weight: bold; font-size: 18px;
}
.profile-desc {
  color: #555; font-size: 13px; margin-top: 3px;
}
.profile-meta {
  color: #888; font-size: 12px; margin-top: 2px;
}
    .video-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .video-item img {
      width: 120px;
      cursor: pointer;
      border-radius: 4px;
      transition: transform 0.2s ease;
    }
    .video-item img:hover {
      transform: scale(1.05);
    }
    .video-info {
      display: flex;
      flex-direction: column;
    }
    .video-title {
      font-weight: 600;
      margin-bottom: 6px;
    }
    h3 {
      margin-top: 28px;
      margin-bottom: 10px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 4px;
    }
    .more-btn {
      margin: 12px 0 24px 0;
      padding: 6px 14px;
      border-radius: 5px;
      background: #f5f5f5;
      border: 1px solid #bbb;
      cursor: pointer;
      color: #222;
      font-size: 14px;
    }
    .more-btn:hover {
      background: #e8e8e8;
    }
    .sns-panel {
      margin-bottom: 40px;
      border-radius: 8px;
      background: #fcfcfc;
      border: 1px solid #e5e5e5;
      padding: 18px 20px 20px 20px;
      box-shadow: 0px 1px 7px 0px #f0f0f0;
    }
    .sns-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .removeBtn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #888;
    }
    .removeBtn:hover {
      color: #d00;
    }
    .sns-controls {
      margin-bottom: 28px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #snsPanels {
      margin-top: 22px;
    }
.youtube-sections {
  display: flex;
  gap: 24px;
  justify-content: flex-start;
  flex-wrap: wrap; /* ì¤„ë°”ê¿ˆ í—ˆìš© */
}
.youtube-section {
  flex: 1 1 400px;      /* ìµœì†Œ 320px, ë‚¨ëŠ” ê³µê°„ ë¹„ìœ¨ë¡œ ì±„ì›€ */
  max-width: 800px;     /* ìµœëŒ€ 400px */
  min-width: 260px;     /* ìµœì†Œ 260px */
  background: #fafbfc;
  border-radius: 8px;
  padding: 10px 10px 18px 10px;
  box-shadow: 0 1px 4px #eee;
  margin-bottom: 16px;
}
.youtube-section h3 {
  text-align: center;
  margin-top: 0;
}

  </style>
</head>
<body>
 <h1>ì¶”ì²œ ê²€ìƒ‰</h1>
  <div id="suggest-section" style="margin-bottom:30px;">
  <form id="suggest-form" style="display:flex;gap:8px;">
    <input type="text" id="suggest-input" placeholder="ì¶”ì²œë°›ê³  ì‹¶ì€ ì•„í‹°ìŠ¤íŠ¸ ì„¤ëª…, í‚¤ì›Œë“œ ë“±ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1;padding:8px;font-size:16px;">
    <button type="submit" style="padding:8px 16px;">ì¶”ì²œ ê²€ìƒ‰</button>
  </form>
  <div id="suggest-result" style="margin-top:18px;"></div>
</div>

  <h1>í†µí•© íƒ€ì„ë¼ì¸ ìš”ì•½</h1>
  <div class="sns-controls">
    <select id="snsType">
      <option value="youtube">YouTube</option>
      <option value="twitter">Twitter</option>
      <option value="instagram">Instagram</option>
      <option value="bluesky">Bluesky</option>
      <option value="mastodon">Mastodon</option>
      <!-- í–¥í›„ ì¶”ê°€ -->
    </select>
    <input id="snsInput" type="text" placeholder="ì±„ë„ URL ë˜ëŠ” ID ì…ë ¥" />
    <button id="addSnsBtn">ì¶”ê°€</button>
  </div>
 <!-- <div id="recentArtists" style="margin-bottom:20px;"></div>-->
  <div id="snsPanels"></div>

<script>
const snsPanels = document.getElementById('snsPanels');
const addSnsBtn = document.getElementById('addSnsBtn');
const snsTypeSelect = document.getElementById('snsType');
const snsInput = document.getElementById('snsInput');
const TWEET_BATCH_SIZE = 10;
const MASTODON_BATCH_SIZE = 10;
  
addSnsBtn.addEventListener('click', () => {
  const type = snsTypeSelect.value;
  const input = snsInput.value.trim();

  if (!input) {
    alert('URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }

  const panel = document.createElement('div');
  panel.className = 'sns-panel';
  panel.innerHTML = `
    <div class="sns-header">
      <strong>${type.toUpperCase()}</strong>
      <button class="removeBtn">âŒ</button>
    </div>
    <div class="sns-content">ğŸ“¡ ë°ì´í„° ë¡œë”© ì¤‘...</div>
  `;
  snsPanels.prepend(panel);

  if (type === 'youtube') {
    createYoutubePanel(panel, input);
  } else if (type === 'twitter') {
    // íŠ¸ìœ„í„°ì˜ ê²½ìš°, URLì´ë©´ ì•„ì´ë””ë§Œ ì¶”ì¶œ(ê°„ë‹¨ ì²˜ë¦¬)
    let username = input;
    if (username.startsWith("https://twitter.com/")) {
      username = username.replace("https://twitter.com/", "").split('/')[0].split('?')[0];
    }
    createTwitterPanel(panel, username);
  } else if (type === 'instagram') {
  let username = input;
    if (username.startsWith("https://www.instagram.com/")) {
      username = username.replace("https://www.instagram.com/", "").split('/')[0].split('?')[0];
    }
  createInstagramPanel(panel, username); // ì¶”ê°€
    } else if (type === 'bluesky') {
    let username = input.replace(/^@/, '');
    createBlueskyPanel(panel, username);
    } else if (type === 'mastodon') {
    // ë§ˆìŠ¤í† ëˆ: username@instance ë˜ëŠ” usernameë§Œ ì…ë ¥ë°›ê³ , ì¸ìŠ¤í„´ìŠ¤ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
    let username = input;
    let instance = "https://mastodon.social";
 if (username.includes('@')) {
    const parts = username.split('@');
    if (parts.length === 3) {
      username = parts[1];
      instance = parts[2].startsWith('http') ? parts[2] : `https://${parts[2]}`;
    } else if (parts.length === 2) {
      username = parts[0];
      instance = parts[1].startsWith('http') ? parts[1] : `https://${parts[1]}`;
    }
  }
    createMastodonPanel(panel, username, instance);
  } else {
    panel.querySelector('.sns-content').innerText = `ì•„ì§ ì§€ì›ë˜ì§€ ì•ŠëŠ” SNS ìœ í˜•ì…ë‹ˆë‹¤: ${type}`;
  }
  snsInput.value = '';
});

snsPanels.addEventListener('click', (e) => {
  if (e.target.classList.contains('removeBtn')) {
    const panel = e.target.closest('.sns-panel');
    if (panel) panel.remove();
  }
});
// ì¶”ì²œ ê²€ìƒ‰ ê¸°ëŠ¥
// ì¶”ì²œ ê²€ìƒ‰ í¼ ì œì¶œ ì´ë²¤íŠ¸
document.getElementById('suggest-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  const input = document.getElementById('suggest-input').value.trim();
  const resultDiv = document.getElementById('suggest-result');
  if (!input) {
    resultDiv.innerHTML = '<span style="color:red;">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</span>';
    return;
  }
  resultDiv.innerHTML = 'â³ ì¶”ì²œ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  try {
    const res = await fetch('/api/recommend_artist', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ description: input })
    });
    const data = await res.json();
    let html = '';

    // 2. AIê°€ ìƒì„±í•œ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ ë²„íŠ¼í™”
    if (data.ai_result && data.ai_result.db_results && data.ai_result.db_results.length) {
      html += `<div><b>AI ê¸°ë°˜ ì¶”ì²œ ê³„ì •</b><ul>`;
      data.ai_result.db_results.forEach(item => {
        let platform = item.platform || '';
        let displayName = item.account_name || item.name || item.url;
        let id = item.url || item.account_name || '';
        html += `<li>
          <button class="recommend-connect-btn"
            data-platform="${platform}"
            data-id="${id}"
            style="margin-bottom:4px;padding:4px 10px;border-radius:5px;border:1px solid #bbb;cursor:pointer;">
            ${displayName}
          </button>
          <span style="color:#666;">${item.description || ''}</span>
        </li>`;
      });
      html += `</ul></div>`;
    }

    // 3. DBì—ì„œ ê°€ì ¸ì˜¨ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ ë²„íŠ¼í™”
    if (data.db_results && data.db_results.length) {
      html += `<div><b>DB ê¸°ë°˜ ì‹¤ì¡´ ê³„ì •</b><ul>`;
      data.db_results.forEach(item => {
        let platform = item.platform || '';
        let displayName = item.account_name || item.name || item.url;
        let id = item.url || item.account_name || '';
        html += `<li>
          <button class="recommend-connect-btn"
            data-platform="${platform}"
            data-id="${id}"
            style="margin-bottom:4px;padding:4px 10px;border-radius:5px;border:1px solid #bbb;cursor:pointer;">
            ${displayName}
          </button>
          <span style="color:#666;">${item.summary || item.description || ''}</span>
        </li>`;
      });
      html += `</ul></div>`;
    }

    if (!html) html = 'ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
    resultDiv.innerHTML = html;
  } catch (err) {
    resultDiv.innerHTML = `<span style="color:red;">ì˜¤ë¥˜: ${err.message}</span>`;
  }
});

// ë²„íŠ¼ í´ë¦­ ì‹œ íƒ€ì„ë¼ì¸ ìë™ ì¶”ê°€

document.getElementById('suggest-result').addEventListener('click', function(e) {
  if (!e.target.classList.contains('recommend-connect-btn')) return;
  const platform = e.target.dataset.platform.toLowerCase();
  const id = e.target.dataset.id;
  // ê¸°ì¡´ SNS ì¶”ê°€ ë²„íŠ¼ê³¼ ë™ì¼í•˜ê²Œ íŒ¨ë„ ì¶”ê°€
  const panel = document.createElement('div');
  panel.className = 'sns-panel';
  panel.innerHTML = `
    <div class="sns-header">
      <strong>${platform.toUpperCase()}</strong>
      <button class="removeBtn">âŒ</button>
    </div>
    <div class="sns-content">ğŸ“¡ ë°ì´í„° ë¡œë”© ì¤‘...</div>
  `;
  snsPanels.prepend(panel);

  if (platform === 'youtube') {
    createYoutubePanel(panel, id);
  } else if (platform === 'twitter') {
    createTwitterPanel(panel, id);
  } else if (platform === 'instagram') {
    createInstagramPanel(panel, id);
  } else if (platform === 'bluesky'){
    createBlueskyPanel(panel, id);
  } else if (platform === 'mastodon') {
    // ë§ˆìŠ¤í† ëˆì€ idê°€ username, instanceëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©(í•„ìš”ì‹œ ìˆ˜ì •)
    createMastodonPanel(panel, id, "https://mastodon.social");
  }
});
document.addEventListener('click', async (e) => {
  if (!e.target.classList.contains('summaryBtn')) return;

  const btn = e.target;
  const mode = btn.dataset.mode;
  const videoUrl = btn.dataset.videourl;
  const title = btn.dataset.title;
  const thumbnailUrl = btn.dataset.thumb;
  const publishDate = btn.dataset.date;

  const videoItem = btn.closest('.video-item');
  const summaryDiv = videoItem.querySelector('.summary-result');
  summaryDiv.innerText = 'â³ ìš”ì•½ ì¤‘...';

  try {
    const res = await fetch('/summary', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        video_url: videoUrl,
        title,
        thumbnail_url: thumbnailUrl,
        publish_date: publishDate,
        mode
      })
    });
    const data = await res.json();

    if (res.ok) {
      summaryDiv.innerText = `ğŸ“„ ìš”ì•½ (${data.mode === 'audio' ? 'ê³ ê¸‰' : 'ê¸°ë³¸'}):\n${data.summary}`;
    } else {
      summaryDiv.innerText = `ìš”ì•½ ì‹¤íŒ¨: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
    }
  } catch (err) {
    summaryDiv.innerText = 'ìš”ì•½ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
    console.error(err);
  }
});
/*
 async function renderRecentArtists() {
  const res = await fetch('/api/recent_artists');
  const list = await res.json();
  const container = document.getElementById('recentArtists');
  if (!list.length) {
    container.innerHTML = '';
    return;
  }
  container.innerHTML = `<strong>ê²€ìƒ‰ ë‚´ì—­</strong><br>` + list.map(item => {
    // SNS ì¢…ë¥˜, ì£¼ì†Œ, ì´ë¦„ ì¶”ì¶œ
    let type = 'ê¸°íƒ€', url = '#';
    if (item.id.startsWith('twitter:')) {
      type = 'íŠ¸ìœ„í„°';
      url = `https://twitter.com/${item.id.replace('twitter:', '')}`;
    } else if (item.id.startsWith('instagram:')) {
      type = 'ì¸ìŠ¤íƒ€ê·¸ë¨';
      url = `https://instagram.com/${item.id.replace('instagram:', '')}`;
      } else if (item.id.startsWith('mastodon:')) {
      type = 'ë§ˆìŠ¤í† ëˆ';
      const mastodonInfo = item.id.replace('mastodon:', '');
      if (mastodonInfo.includes('/@')) {
        const parts = mastodonInfo.split('/@');
        instance = parts[0].replace(/^https?:\/\//, ''); 
        username = parts[1];
        url = `https://${instance}/@${username}`; }
    } else {
      type = 'ìœ íŠœë¸Œ';
      url = item.id;
    }
    return `[${type}] <a href="${url}" target="_blank">${item.name}</a>`;
  }).join('<br>');
}
// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
window.addEventListener('DOMContentLoaded', renderRecentArtists);
*/
function createMastodonPanel(panel, username, instance) {
  const tootListEl = panel.querySelector('.sns-content');
  let toots = [];
  let loadedCount = 0;
  let mastodonUserId = null;
async function loadToots() {
    tootListEl.innerHTML = 'â³ ë§ˆìŠ¤í† ëˆ íˆ¿ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    try {
      // user_idê°€ ìˆìœ¼ë©´ user_idë¡œ, ì—†ìœ¼ë©´ usernameìœ¼ë¡œ ìš”ì²­
      let url = `/api/recent_mastodon_toots?instance=${encodeURIComponent(instance)}&start=${loadedCount}&count=${MASTODON_BATCH_SIZE}`;
      if (mastodonUserId) {
        url += `&user_id=${encodeURIComponent(mastodonUserId)}`;
      } else {
        url += `&username=${encodeURIComponent(username)}`;
      }
      const res = await fetch(url);
      const data = await res.json();
      if(data && data.length) {
        const t = data[0];
        const profileDiv = document.createElement('div');
        profileDiv.className = 'profile-preview';
        profileDiv.style = 'display:flex;align-items:center;margin-bottom:16px;';
        // ì•„ë°”íƒ€(í”„ì‚¬) í•„ë“œê°€ ìˆìœ¼ë©´ ì•„ë˜ ë¼ì¸ í™œì„±í™”
        // let profileImg = t.avatar ? `<img src="${t.avatar}" class="profile-avatar" style="width:48px;height:48px;border-radius:50%;margin-right:12px;">` : '';
        let profileImg = '';
        profileDiv.innerHTML = `
          ${profileImg}
          <div>
            <div class="profile-name" style="font-weight:bold;font-size:18px;">${t.display_name || ''}</div>
            <div class="profile-desc" style="color:#666;font-size:13px;margin-top:4px;">${t.note || ''}</div>
            <div class="profile-meta" style="color:#888;font-size:12px;margin-top:2px;">@${username}@${instance.replace(/^https?:\/\//, '')}</div>
          </div>
        `;
        const header = panel.querySelector('.sns-header');
        // ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
        if(header && !panel.querySelector('.profile-preview')) header.insertAdjacentElement('afterend', profileDiv);
      }
      // user_idë¥¼ ì‘ë‹µì—ì„œ ë°›ì•„ ì €ì¥ (ë°±ì—”ë“œì—ì„œ account_id í¬í•¨ í•„ìš”)
      if (!mastodonUserId && Array.isArray(data) && data.length > 0 && data[0].account_id) {
        mastodonUserId = data[0].account_id;
      }
      if (Array.isArray(data) && data.length > 0) {
        toots = toots.concat(data);
        renderToots();
        loadedCount = toots.length;
      } else if (loadedCount === 0) {
        tootListEl.innerHTML = '<p>íˆ¿ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
    } catch (err) {
      tootListEl.innerHTML = '<p>íˆ¿ ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬</p>';
      console.error(err);
    }
  }
async function renderToots() {
  tootListEl.innerHTML = '';

  const contents = toots.map(t => t.content);

  // 2. ë²ˆì—­ ë¬¶ìŒ ìš”ì²­
  let translations = [];
  if (contents.length) {
    const res = await fetch('/api/translate_if_needed', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ texts: contents })
    });
    const data = await res.json();
    translations = data.translated || [];
        await fetch('/api/save_search_history', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: username,
        platform: 'mastodon',
        account_name: username,
        url: `${instance}/@${username}`,
        success: true,
        description: contents.join('\n'),
        summary: '',
        user_id: null
      })
    });
  }
const saveRes = await fetch('/api/save_search_history', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: username,
    platform: 'mastodon',
    account_name: username,
    url: `${instance}/@${username}`,
    success: true,
    description: contents.join('\n'),
    summary: '',
    user_id: null
  })
});
const saveData = await saveRes.json();
if (!saveRes.ok || saveData.result !== 'ok') {
  console.error('DB ì €ì¥ ì‹¤íŒ¨:', saveData);
}
  // 3. ë Œë”ë§ (ë²ˆì—­ ê²°ê³¼ ë§¤í•‘)
  toots.forEach((t, idx) => {
    const div = document.createElement('div');
    div.className = 'mastodon-toot-item';
    div.innerHTML = `
      <div style="font-size:15px;">${t.content}</div>
      <div style="font-size:11px;color:#888;margin-top:4px;">
        <a href="${t.url}" target="_blank">íˆ¿ ë°”ë¡œê°€ê¸°</a>
        | ${t.date}
        | ğŸ’¬ ${t.reply_count} ğŸ” ${t.reblog_count} â­ ${t.favourite_count}
        <button class="reactionBtn" data-statusid="${t.status_id}" data-instance="${instance}" style="margin-left:10px;">ë°˜ì‘ ë³´ê¸°</button>
      </div>
      <div class="reaction-result" style="margin-top:10px; font-size:13px; color:#222;"></div>
    `;
    // ë²ˆì—­ ê²°ê³¼ í‘œì‹œ
    const translationDiv = document.createElement('div');
    translationDiv.className = 'mastodon-translation';
    translationDiv.style = 'font-size:12px; color:#888; margin-left:2px; display:none;';
    if (translations[idx]) {
      translationDiv.innerText = translations[idx];
      translationDiv.style.display = 'block';
    }
    div.appendChild(translationDiv);
    tootListEl.appendChild(div);
  });

  // ë”ë³´ê¸° ë²„íŠ¼
  if (toots.length > 0 && toots.length % MASTODON_BATCH_SIZE === 0) {
    const moreBtn = document.createElement('button');
    moreBtn.innerText = 'ë”ë³´ê¸°';
    moreBtn.className = 'more-btn';
    moreBtn.onclick = loadToots;
    tootListEl.appendChild(moreBtn);
  }
}
  // ë°˜ì‘ ìš”ì•½(ëŒ“ê¸€/ì¸ìš©) ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„
tootListEl.addEventListener('click', function(e) {
  if (!e.target.classList.contains('reactionBtn')) return;
  const btn = e.target;
  const status_id = btn.dataset.statusid;
  const instance = btn.dataset.instance;
  const resultDiv = btn.closest('.mastodon-toot-item').querySelector('.reaction-result');
  resultDiv.innerText = 'â³ ë°˜ì‘ ìš”ì•½ ì¤‘...';
  (async function() {
    try {
      const res = await fetch(`/api/mastodon_toot_reactions?status_id=${encodeURIComponent(status_id)}&instance=${encodeURIComponent(instance)}`);
      const data = await res.json();
      if (res.ok) {
        resultDiv.innerText = `ğŸ“¢ ë°˜ì‘ ìš”ì•½:\n${data.summary}`;
      } else {
        resultDiv.innerText = `ìš”ì•½ ì‹¤íŒ¨: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
      }
    } catch (err) {
      resultDiv.innerText = 'ìš”ì•½ ì‹¤íŒ¨';
      console.error(err);
    }
  })();
});

// ìµœì´ˆ ë¡œë“œ
loadToots();
}

function createBlueskyPanel(panel, username) {
  const skyListEl = panel.querySelector('.sns-content');
  let skys = [];
  let loadedCount = 0;
  const SKY_BATCH_SIZE = 10;

  async function loadSkys() {
    skyListEl.innerHTML = 'â³ ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    const res = await fetch(`/api/recent_bluesky_skys?username=${encodeURIComponent(username)}&start=${loadedCount}&count=${SKY_BATCH_SIZE}`);
    const data = await res.json();
    if (Array.isArray(data) && data.length > 0) {
      skys = skys.concat(data);
      renderSkys();
      loadedCount = skys.length;
    } else if (loadedCount === 0) {
      skyListEl.innerHTML = '<p>ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
  }

  function renderSkys() {
    skyListEl.innerHTML = '';
    skys.forEach(s => {
      const div = document.createElement('div');
      div.className = 'bluesky-post-item';
      div.innerHTML = `
        <div style="font-size:15px;">${s.content}</div>
        <div style="font-size:11px;color:#888;margin-top:4px;">
          <a href="${s.url}" target="_blank">ê²Œì‹œë¬¼ ë°”ë¡œê°€ê¸°</a>
          | ${s.date}
          | <button class="reactionBtn" data-postid="${s.post_id}" style="margin-left:10px;">ë°˜ì‘ ë³´ê¸°</button>
        </div>
        <div class="reaction-result" style="margin-top:10px; font-size:13px; color:#222;"></div>
      `;
      skyListEl.appendChild(div);
    });

    // ë”ë³´ê¸° ë²„íŠ¼
    if (skys.length > 0 && skys.length % SKY_BATCH_SIZE === 0) {
      const moreBtn = document.createElement('button');
      moreBtn.innerText = 'ë”ë³´ê¸°';
      moreBtn.className = 'more-btn';
      moreBtn.onclick = loadSkys;
      skyListEl.appendChild(moreBtn);
    }
  }

  // ë°˜ì‘ ìš”ì•½ ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„
  skyListEl.addEventListener('click', async e => {
    if (!e.target.classList.contains('reactionBtn')) return;
    const btn = e.target;
    const postId = btn.dataset.postid;
    const resultDiv = btn.closest('.bluesky-post-item').querySelector('.reaction-result');
    resultDiv.innerText = 'â³ ë°˜ì‘ ìš”ì•½ ì¤‘...';
    const res = await fetch(`/api/bluesky_sky_reactions?post_id=${encodeURIComponent(postId)}`);
    const data = await res.json();
    if (data.summary) {
      resultDiv.innerText = `ğŸ“¢ ë°˜ì‘ ìš”ì•½:\n${data.summary}`;
    } else {
      resultDiv.innerText = 'ìš”ì•½ ì‹¤íŒ¨';
    }
  });

  // ìµœì´ˆ ë¡œë“œ
  loadSkys();
}

function createInstagramPanel(panel, username) {
  const postListEl = panel.querySelector('.sns-content');
  let posts = [];
  let loadedCount = 0;
  const POST_BATCH_SIZE = 10;

  async function loadPosts() {
    postListEl.innerHTML = 'â³ ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    const res = await fetch(`/api/recent_instagram_posts?username=${encodeURIComponent(username)}&start=${loadedCount}&count=${POST_BATCH_SIZE}`);
    const data = await res.json();
    if (Array.isArray(data) && data.length > 0) {
      posts = posts.concat(data);
      renderPosts();
      loadedCount = posts.length;
    } else if (loadedCount === 0) {
      postListEl.innerHTML = '<p>ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
  }

function renderPosts() {
  postListEl.innerHTML = '';
  posts.forEach(p => {
    const div = document.createElement('div');
    div.className = 'instagram-post-item';
    div.innerHTML = `
      <div>${p.image_url ? `<img src="${p.image_url}" style="max-width:120px;"/>` : ''}</div>
      <div class="caption-text" style="font-weight:600;">${p.caption || ''}</div>
      <div class="caption-translation" style="font-size:12px; color:#888; display:none;"></div>
      <div style="font-size:12px; color:#888;">${p.date}</div>
      <button class="reactionBtn" data-shortcode="${p.shortcode}">ë°˜ì‘ ìš”ì•½</button>
      <div class="reaction-result"></div>
    `;
    postListEl.appendChild(div);

    // ë²ˆì—­ ì²˜ë¦¬
    const translationDiv = div.querySelector('.caption-translation');
    if (p.caption && p.caption.length > 0) {
      fetch('/api/translate_if_needed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: p.caption })
      })
      .then(res => res.json())
      .then(data => {
        if (data.need_translate && data.translated) {
          translationDiv.innerText = data.translated;
          translationDiv.style.display = 'block';
        }
      });
    }
  });

  // ë”ë³´ê¸° ë²„íŠ¼
  if (posts.length > 0 && posts.length % POST_BATCH_SIZE === 0) {
    const moreBtn = document.createElement('button');
    moreBtn.innerText = 'ë”ë³´ê¸°';
    moreBtn.className = 'more-btn';
    moreBtn.onclick = loadPosts;
    postListEl.appendChild(moreBtn);
  }
}

  // ë°˜ì‘ ìš”ì•½(ëŒ“ê¸€ ìš”ì•½) ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„
  postListEl.addEventListener('click', async e => {
    if (!e.target.classList.contains('reactionBtn')) return;
    const btn = e.target;
    const shortcode = btn.dataset.shortcode;
    const resultDiv = btn.closest('.instagram-post-item').querySelector('.reaction-result');
    resultDiv.innerText = 'â³ ë°˜ì‘ ìš”ì•½ ì¤‘...';
    const res = await fetch(`/api/instagram_post_reactions?shortcode=${encodeURIComponent(shortcode)}`);
    const data = await res.json();
    if (data.summary) {
      resultDiv.innerText = `ğŸ“¢ ë°˜ì‘ ìš”ì•½:\n${data.summary}`;
    } else {
      resultDiv.innerText = 'ìš”ì•½ ì‹¤íŒ¨';
    }
  });

  // ìµœì´ˆ ë¡œë“œ
  loadPosts();
}
  
function createTwitterPanel(panel, username) {
  const tweetListEl = panel.querySelector('.sns-content');
  let tweets = [];
  let loadedCount = 0;

  async function loadTweets() {
    tweetListEl.innerHTML = 'â³ íŠ¸ìœ— ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    try {
      const res = await fetch(`/api/recent_tweets?username=${encodeURIComponent(username)}&start=${loadedCount}&count=${TWEET_BATCH_SIZE}`);
      const data = await res.json();
      if (res.ok) {
        if (Array.isArray(data) && data.length > 0) {
          tweets = tweets.concat(data);
          renderTweets();
          loadedCount = tweets.length;
        } else if (loadedCount === 0) {
          tweetListEl.innerHTML = '<p>íŠ¸ìœ—ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
      } else {
        tweetListEl.innerHTML = `<p>íŠ¸ìœ— ë¡œë”© ì˜¤ë¥˜: ${data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}</p>`;
      }
    } catch (err) {
      tweetListEl.innerHTML = '<p>íŠ¸ìœ— ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬</p>';
      console.error(err);
    }
  }

  async function renderTweets() {
    tweetListEl.innerHTML = '';
    // 1. íŠ¸ìœ— ë³¸ë¬¸ì„ í•œ ë²ˆì— ì¶”ì¶œ
    const tweetContents = tweets.map(t => t.content);
    // 2. ë²ˆì—­ ë¬¶ìŒ ìš”ì²­
    let translations = [];
    if (tweetContents.length) {
      const res = await fetch('/api/translate_if_needed', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ texts: tweetContents })
      });
      const data = await res.json();
      translations = data.translated || [];
          await fetch('/api/save_search_history', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: username, // íŠ¸ìœ„í„° ê³„ì •ëª…
        platform: 'twitter',
        account_name: username,
        url: `https://twitter.com/${username}`,
        success: true,
        description: tweetContents.join('\n'),
        summary: '',
        user_id: null
      })
    });
    }
    tweets.forEach((t, idx) => {
      const div = document.createElement('div');
      div.className = 'tweet-item';
      div.style.marginBottom = "18px";
      div.style.paddingBottom = "8px";
      div.innerHTML = `
        <div style="font-size:15px;">${t.content}</div>
        <div style="font-size:11px;color:#888;margin-top:4px;">
          <a href="${t.url}" target="_blank">íŠ¸ìœ— ë°”ë¡œê°€ê¸°</a>
          | ${t.date}
          | â¤ ${t.like_count} ğŸ” ${t.retweet_count} ğŸ’¬ ${t.reply_count}
          <button class="reactionBtn" data-username="${t.username}" data-tweetid="${t.tweet_id}" style="margin-left:10px;">ë°˜ì‘ ë³´ê¸°</button>
        </div>
        <div class="reaction-result" style="margin-top:10px; font-size:13px; color:#222;"></div>
      `;
      // ë²ˆì—­ ê²°ê³¼ í‘œì‹œ
      const translationDiv = document.createElement('div');
      translationDiv.className = 'tweet-translation';
      translationDiv.style = 'font-size:12px; color:#888; margin-left:2px; display:none;';
      if (translations[idx]) {
        translationDiv.innerText = translations[idx];
        translationDiv.style.display = 'block';
      }
      div.appendChild(translationDiv);
      tweetListEl.appendChild(div);
    });

    // ë”ë³´ê¸° ë²„íŠ¼
    if (tweets.length === 0 || tweets.length % TWEET_BATCH_SIZE !== 0) return;
    const moreBtn = document.createElement('button');
    moreBtn.innerText = 'ë”ë³´ê¸°';
    moreBtn.className = 'more-btn';
    moreBtn.onclick = loadTweets;
    tweetListEl.appendChild(moreBtn);
  } // â† renderTweets í•¨ìˆ˜ ë‹«ëŠ” ì¤‘ê´„í˜¸

  // íŠ¸ìœ— ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆì— ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ìœ¼ë¡œ ë¦¬ìŠ¤ë„ˆ ë¶€ì°©
  tweetListEl.addEventListener('click', async (e) => {
    if (!e.target.classList.contains('reactionBtn')) return;
    const btn = e.target;
    const username = btn.dataset.username;
    const tweetId = btn.dataset.tweetid;
    const resultDiv = btn.closest('.tweet-item').querySelector('.reaction-result');
    resultDiv.innerText = 'â³ íŠ¸ìœ— ë°˜ì‘ ìš”ì•½ ì¤‘...';

    try {
      const res = await fetch(`/api/tweet_reactions?username=${encodeURIComponent(username)}&tweet_id=${encodeURIComponent(tweetId)}`);
      const data = await res.json();
      if (res.ok) {
        resultDiv.innerText = `ğŸ“¢ ë°˜ì‘ ìš”ì•½:\n${data.summary}`;
      } else {
        resultDiv.innerText = `ìš”ì•½ ì‹¤íŒ¨: ${data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
      }
    } catch (err) {
      resultDiv.innerText = 'ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
      console.error(err);
    }
  });

  // ìµœì´ˆ ë¡œë“œ
  loadTweets();
}
  
function createYoutubePanel(panel, inputUrl) {
  const videoListEl = panel.querySelector('.sns-content');
  let allGrouped = { "ë¼ì´ë¸Œ": [], "ì‡¼ì¸ ": [], "ì¼ë°˜": [] };
  let loadedCount = { "ë¼ì´ë¸Œ": 0, "ì‡¼ì¸ ": 0, "ì¼ë°˜": 0 };
  const BATCH_SIZE = 5;

  async function fetchAndGroupVideos(channelUrl) {
    videoListEl.innerHTML = 'â³ ì˜ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    try {
      // 1. ì „ì²´ ë¦¬ìŠ¤íŠ¸ ë°›ì•„ì˜¤ê¸°
      const res = await fetch(`/api/video_ids?channel_url=${encodeURIComponent(channelUrl)}`);
      const videoList = await res.json(); // [{id, title, publish_date, type}, ...]
      if (!videoList || !Array.isArray(videoList) || videoList.length === 0) {
        videoListEl.innerHTML = '<p>ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }
      if(videoList && videoList.length) {
        const v = videoList[0];
        // í”„ë¡œí•„ í‘œì‹œ HTML ìƒì„±
        const profileDiv = document.createElement('div');
        profileDiv.className = 'profile-preview';
        profileDiv.style = 'display:flex;align-items:center;margin-bottom:16px;';
        // ì¸ë„¤ì¼(ì±„ë„ í”„ì‚¬) ì •ë³´ê°€ ìˆë‹¤ë©´ ì•„ë˜ ë¼ì¸ ì¶”ê°€
        // let profileImg = v.channel_thumbnail ? `<img src="${v.channel_thumbnail}" style="width:48px;height:48px;border-radius:50%;margin-right:12px;">` : '';
        let profileImg = '';
        profileDiv.innerHTML = `
          ${profileImg}
    <div>
      <div class="profile-name" style="font-weight:bold;font-size:18px;">${v.channel_title || ''}</div>
      <div class="profile-desc" style="color:#666;font-size:13px;margin-top:4px;">${v.channel_description || ''}</div>
      <div class="profile-desc-translation" style="color:#888;font-size:12px;margin-top:4px; display:none;"></div>
    </div>
        `;
        // .sns-header ë°”ë¡œ ë’¤ì— ì‚½ì…
  const header = panel.querySelector('.sns-header');
  if(header) header.insertAdjacentElement('afterend', profileDiv);

  // desc ì„ ì–¸ ì¶”ê°€
  const desc = v.channel_description || '';
  if (desc) {
    const translationDiv = profileDiv.querySelector('.profile-desc-translation');
    fetch('/api/translate_if_needed', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: desc })
    })
    .then(res => res.json())
    .then(data => {
      if (data.need_translate && data.translated) {
        translationDiv.innerText = data.translated;
        translationDiv.style.display = 'block';
      }
    });
  }
}

      // 2. ê·¸ë£¹í•‘
      allGrouped = { "ë¼ì´ë¸Œ": [], "ì‡¼ì¸ ": [], "ì¼ë°˜": [] };
      videoList.forEach(v => { if (allGrouped[v.type]) allGrouped[v.type].push(v); });
      loadedCount = {
        "ì¼ë°˜": Math.min(BATCH_SIZE, allGrouped["ì¼ë°˜"].length),
        "ì‡¼ì¸ ": Math.min(BATCH_SIZE, allGrouped["ì‡¼ì¸ "].length),
        "ë¼ì´ë¸Œ": Math.min(BATCH_SIZE, allGrouped["ë¼ì´ë¸Œ"].length)
      };
      await renderVideosByType();
    } catch (err) {
      videoListEl.innerText = 'âŒ ì˜ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜';
      console.error(err);
    }
  }

  // í•œ ì¢…ë¥˜(type)ë§Œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
  async function renderVideosByTypeSingle(type) {
    const section = document.querySelector(`.youtube-section[data-type="${type}"]`);
    if (!section) return;
    section.innerHTML = `<h3>${type}</h3>`;

    // í˜„ì¬ í™”ë©´ì— ë³´ì—¬ì¤„ idë§Œ ì¶”ì¶œ
    const currentSlice = allGrouped[type].slice(0, loadedCount[type]);
    const idsForDetails = currentSlice.map(v => v.id);

    // ìƒì„¸ì •ë³´ ìš”ì²­
    let detailsArr = [];
    if (idsForDetails.length) {
      const detailsRes = await fetch('/api/video_details', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ video_ids: idsForDetails })
      });
      detailsArr = await detailsRes.json();
    }
    const detailsMap = {};
    detailsArr.forEach(item => { detailsMap[item.id] = item; });

  const titles = currentSlice.map(v => v.title);
  let translations = [];
  if (titles.length) {
    const res = await fetch('/api/translate_if_needed', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ texts: titles })
    });
    const data = await res.json();
    translations = data.translated || [];
  }

    // ìƒì„¸ì •ë³´ì™€ ë³‘í•© í›„ í‘œì‹œ
    currentSlice.forEach((v,idx) => {
      const detail = detailsMap[v.id] || {};
      const div = document.createElement('div');
      div.className = 'video-item';
      let badge = '';
      if (type === "ë¼ì´ë¸Œ") {
        badge = '<span style="color:white;background:red;border-radius:4px;padding:2px 6px;font-size:12px;margin-left:8px;">LIVE</span>';
      } else if (type === "ì‡¼ì¸ ") {
        badge = '<span style="color:white;background:#222;border-radius:4px;padding:2px 6px;font-size:12px;margin-left:8px;">SHORTS</span>';
      }
      div.innerHTML = `
        <a href="https://www.youtube.com/watch?v=${v.id}" target="_blank">
          <img src="${detail.thumbnail_url || ''}" alt="ì¸ë„¤ì¼" />
        </a>
        <div class="video-info">
          <div class="video-title">${v.title} ${badge}</div>
          <div style="font-size:12px; color:#888;">ê³µê°œ: ${detail.publish_date || v.publish_date || ''}</div>
          <button class="summaryBtn"
            data-mode="description"
            data-videourl="https://www.youtube.com/watch?v=${v.id}"
            data-title="${v.title}"
            data-thumb="${detail.thumbnail_url || ''}"
            data-date="${detail.publish_date || v.publish_date || ''}"
          >ì˜ìƒ ì†Œê°œ</button>
          <button class="summaryBtn"
            data-mode="audio"
            data-videourl="https://www.youtube.com/watch?v=${v.id}"
            data-title="${v.title}"
            data-thumb="${detail.thumbnail_url || ''}"
            data-date="${detail.publish_date || v.publish_date || ''}"
          >ë‚´ìš© ìš”ì•½</button>
          <div class="summary-result" style="margin-top:8px; font-size:14px; color:#333;"></div>
          <div class="sns-link-btns"></div>
        </div>
      `;
      const snsBtnsDiv = div.querySelector('.sns-link-btns');
      let links = detail.sns_links || v.sns_links || [];
      if (!Array.isArray(links)) links = [];
  links.forEach(link => {
    const btn = document.createElement('button');
    btn.className = 'sns-link-btn';
    let displayName = '';
    if (link.platform === 'twitter') displayName = 'íŠ¸ìœ„í„° íƒ€ì„ë¼ì¸';
    else if (link.platform === 'instagram') displayName = 'ì¸ìŠ¤íƒ€ê·¸ë¨ ê²Œì‹œë¬¼';
    else if (link.platform === 'mastodon') displayName = 'ë§ˆìŠ¤í† ëˆ íƒ€ì„ë¼ì¸';
    else displayName = 'í™ˆí˜ì´ì§€';
    btn.innerText = displayName;
    btn.dataset.platform = link.platform;
    btn.dataset.id = link.id;
    btn.style = 'margin:3px 4px; padding:2px 10px; border-radius:4px; border:1px solid #bbb; background:#f9f9f9;';
    btn.onclick = function() {
      // í™ˆí˜ì´ì§€(website)ëŠ” íŒ¨ë„ ìƒì„± ì—†ì´ ìƒˆ ì°½ë§Œ ì—´ê³  ì¢…ë£Œ
   const allowed = ["youtube", "twitter", "instagram", "mastodon", "bluesky"];
  if (!allowed.includes(link.platform)) {
    // í™ˆí˜ì´ì§€ ë“±ì€ ìƒˆ ì°½ë§Œ ì—´ê³ , ê¸°íƒ€ëŠ” ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•Šê²Œ í•˜ë ¤ë©´ ì•„ë˜ì²˜ëŸ¼
    if (link.url) window.open(link.url, "_blank");
    return;
  }
      // â†“ ì•„ë˜ëŠ” SNS íŒ¨ë„ ìƒì„± ì½”ë“œ
      const newPanel = document.createElement('div');
      newPanel.className = 'sns-panel';
      newPanel.innerHTML = `
        <div class="sns-header">
          <strong>${link.platform.toUpperCase()}</strong>
          <button class="removeBtn">âŒ</button>
        </div>
        <div class="sns-content">ğŸ“¡ ë°ì´í„° ë¡œë”© ì¤‘...</div>
      `;
      snsPanels.prepend(newPanel);
      if (link.platform === "youtube") {
        createYoutubePanel(newPanel, link.url);
      } else if (link.platform === "twitter") {
        createTwitterPanel(newPanel, link.id);
      } else if (link.platform === "instagram") {
        createInstagramPanel(newPanel, link.id);
      } else if (link.platform === "mastodon") {
        let [username, instance] = link.id.split('@');
        instance = instance ? 'https://' + instance : 'https://mastodon.social';
        createMastodonPanel(newPanel, username, instance);
      } else {
        window.open(link.url, "_blank");
      }
    };
    snsBtnsDiv.appendChild(btn);
  });
      const titleDiv = div.querySelector('.video-title');
    const translationDiv = document.createElement('div');
    translationDiv.className = 'video-title-translation';
    translationDiv.style = 'font-size:12px; color:#888; margin-left:2px; display:none;';
    if (translations[idx]) {
      translationDiv.innerText = translations[idx];
      translationDiv.style.display = 'block';
    }
    titleDiv.parentNode.insertBefore(translationDiv, titleDiv.nextSibling);
    section.appendChild(div);
  });
    // ë”ë³´ê¸° ë²„íŠ¼
    if (loadedCount[type] < allGrouped[type].length) {
      const moreBtn = document.createElement('button');
      moreBtn.innerText = 'ë”ë³´ê¸°';
      moreBtn.className = 'more-btn';
      moreBtn.onclick = async () => {
        loadedCount[type] = Math.min(loadedCount[type] + BATCH_SIZE, allGrouped[type].length);
        await renderVideosByTypeSingle(type); // í•œ ì¢…ë¥˜ë§Œ ë‹¤ì‹œ ê·¸ë¦¼
      };
      section.appendChild(moreBtn);
    }
  }

  // ì „ì²´ ë Œë”ë§ í•¨ìˆ˜
  async function renderVideosByType() {
    videoListEl.innerHTML = '';
    const sectionsContainer = document.createElement('div');
    sectionsContainer.className = 'youtube-sections';
    for (const type of ["ì¼ë°˜", "ì‡¼ì¸ ", "ë¼ì´ë¸Œ"]) {
      if (!allGrouped[type] || allGrouped[type].length === 0) continue;
      const section = document.createElement('div');
      section.className = 'youtube-section';
      section.setAttribute('data-type', type); // typeë³„ë¡œ êµ¬ë¶„
      section.innerHTML = `<h3>${type}</h3>`;
      sectionsContainer.appendChild(section);
    }
    videoListEl.appendChild(sectionsContainer);

    // ê° ì¢…ë¥˜ë³„ë¡œ í•œ ë²ˆì”© ë Œë”ë§
    for (const type of ["ì¼ë°˜", "ì‡¼ì¸ ", "ë¼ì´ë¸Œ"]) {
      if (!allGrouped[type] || allGrouped[type].length === 0) continue;
      await renderVideosByTypeSingle(type);
    }
  }

  // ìµœì´ˆ ë¡œë“œ
  fetchAndGroupVideos(inputUrl);
};

</script>
</body>
</html>
